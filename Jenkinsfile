pipeline{
    agent any
    environment{
        registry = "lamecoder/malysis"
        registryCredential = 'docker-hub-credentials'        
    }
    
    stages{
        stage ('Cloning') { 
                steps { 
                    echo 'Cloning repository'
                    checkout scm
                }
            }
       stage('Building image') {
          steps{
            script {
              dockerImage = docker.build("lamecoder/malysis:${env.BUILD_ID}")
            }
          }
        }
        stage ('Test') { 
            steps { 
                echo 'Testing build'
		    script {
                d = docker.build("test:${env.BUILD_ID}","/media")
		    d.run()
              }
            }
         }
       stage('Deploy Image') {
          steps{
             script {
                docker.withRegistry('https://registry-1.docker.io/v2/', registryCredential) {
                dockerImage.push('latest')
                }
            }
          }
        }
    }
}
