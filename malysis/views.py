from django.shortcuts import render
import sys
import os

from malysis.models import DataStorage

# Create your views here.
def formPage(request):
    data = {}
    if request.method == 'POST':
        script_dir = os.path.dirname( __file__ )
        pathOfLibraries = os.path.join(script_dir, 'libraries')

        pdfIdPath = os.path.join(pathOfLibraries, 'pdfid_PL-0.0.11b')
        sys.path.append(pdfIdPath)

        origapyPath = os.path.join(pathOfLibraries, 'origapy-0.09')
        sys.path.append(origapyPath)

        oletoolsPath = os.path.join(pathOfLibraries, 'oletools-0.60.1', 'oletools')
        sys.path.append(oletoolsPath)

        import pdfid_PL as pdfid
        import origapy
        import pyxswf

        print('Hi')

        mod = DataStorage()
        mod.name = request.POST.get('name')
        mod.file = request.FILES['file']
        mod.save()

        print(mod.pk)

        form = DataStorage.objects.filter(id = mod.pk)
        for i in form:
            print(i.file.url)
            xmldoc, cleaned = pdfid.PDFiD(os.path.dirname(os.path.dirname( __file__ )) + i.file.url, raise_exceptions=True, return_cleaned=True, force=True, output_file='cleaned.pdf') 
            pretty_xml_as_string = xmldoc.toprettyxml()
            print(pretty_xml_as_string)
            data['details'] = pretty_xml_as_string
            if cleaned:
                data['result'] = 'Malicious'
                print('Malicious (according to PDFiD)')
            else:
                data['result'] = 'Benign'
                print('Clean (according to PDFiD)')
        
        return render(request, 'templates/output.html', data)

    else:
        return render(request, 'templates/index.html')